<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enquiry Matrix Report Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .table-wrapper {
            max-height: 600px;
            overflow: auto;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        thead th {
            position: sticky;
            top: 0;
            background-color: #1f2937; /* Dark Gray */
            color: white;
            z-index: 10;
        }
        tbody th {
            position: sticky;
            left: 0;
            background-color: #f9fafb;
            z-index: 5;
            text-align: left;
        }
        /* Sticky Column Layering */
        thead th:first-child { left: 0; z-index: 20; }
        thead th:nth-child(2) { left: 0; z-index: 20; } /* Fallback if single col */
        
        /* If network wise is on, we need 2 sticky cols. We handle this via JS classes mostly, 
           but basic CSS support helps. */
        .sticky-col-1 { position: sticky; left: 0; z-index: 6; background-color: #f9fafb; border-right: 1px solid #e5e7eb; }
        .sticky-col-2 { position: sticky; left: 120px; z-index: 6; background-color: #f9fafb; border-right: 1px solid #e5e7eb; }
        
        thead th.sticky-col-1 { z-index: 21; left: 0; }
        thead th.sticky-col-2 { z-index: 21; left: 120px; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-4 text-gray-800">ðŸ“Š Daily Enquiry Matrix Report</h1>
        <p class="text-sm text-gray-600 mb-2">Paste your raw CSV data below. <b> <<------ : @Ambujgarg_official</b> </p>

        <!-- Input Section -->
        <textarea id="csvInput" class="w-full h-40 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-xs font-mono" placeholder="Paste data here..."></textarea>
        
        <div class="flex flex-wrap items-center gap-4 mt-4">
            <button onclick="generateReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded font-medium transition">
                Generate Report
            </button>
            <button onclick="clearInput()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-5 py-2 rounded font-medium transition">
                Clear
            </button>
            
            <div class="flex items-center gap-2 ml-2 border-l pl-4 border-gray-300">
                <input type="checkbox" id="showNetwork" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500">
                <label for="showNetwork" class="text-sm font-medium text-gray-700 select-none cursor-pointer">Show Network Wise (Network Code)</label>
            </div>
        </div>

        <!-- Debug Info (Hidden by default, shown on success to confirm columns) -->
        <div id="debugInfo" class="hidden mt-4 text-xs text-blue-600 bg-blue-50 p-2 rounded border border-blue-200"></div>

        <!-- Output Section -->
        <div id="outputSection" class="hidden mt-8">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-xl font-semibold text-gray-700">Report Preview</h2>
                <div class="flex gap-2">
                    <button onclick="copyTable()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded text-sm transition flex items-center gap-2">
                        ðŸ“‹ Copy to Clipboard
                    </button>
                    <button onclick="exportCSV()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1.5 rounded text-sm transition flex items-center gap-2">
                        ðŸ“¥ Download CSV
                    </button>
                </div>
            </div>

            <div id="errorMsg" class="hidden p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert"></div>

            <div class="table-wrapper bg-white">
                <table id="reportTable" class="min-w-full text-sm text-left text-gray-600">
                    <!-- Table content will be injected here -->
                </table>
            </div>
            <div id="stats" class="mt-2 text-xs text-gray-500 text-right"></div>
        </div>
    </div>

    <script>
        let finalGrid = []; 

        // Robust CSV Parser
        function parseRow(text, delimiter) {
            if (delimiter === '\t') return text.split('\t').map(c => c.trim().replace(/^"|"$/g, ''));
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') { inQuotes = !inQuotes; } 
                else if (char === delimiter && !inQuotes) {
                    result.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else { current += char; }
            }
            result.push(current.trim().replace(/^"|"$/g, ''));
            return result;
        }

        // Improved Date Parser for DD-MM-YYYY
        function formatDate(dateStr) {
            if (!dateStr) return null;
            let parts = dateStr.trim().split(/[\-\/\s\.]+/); 
            parts = parts.filter(p => p.length > 0 && !isNaN(p));
            
            if (parts.length < 3) return null;

            let p1 = parseInt(parts[0]);
            let p2 = parseInt(parts[1]);
            let p3 = parseInt(parts[2]); 

            let day, month, year;
            if (p3 > 1000) { day = p1; month = p2 - 1; year = p3; } // DD-MM-YYYY
            else if (p1 > 1000) { year = p1; month = p2 - 1; day = p3; } // YYYY-MM-DD
            else { if (p3 < 100) p3 += 2000; day = p1; month = p2 - 1; year = p3; } // DD-MM-YY

            if (month < 0 || month > 11 || day < 1 || day > 31) return null;
            const d = new Date(year, month, day);
            if (isNaN(d.getTime())) return null;

            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            return {
                iso: d.getTime(), 
                label: `${day < 10 ? '0'+day : day}-${months[month]}` 
            };
        }

        function getColumnIndex(headers, keywords) {
            for (const keyword of keywords) {
                const index = headers.findIndex(h => h.includes(keyword));
                if (index !== -1) return { index, keyword };
            }
            return { index: -1, keyword: null };
        }

        // Logic to extract Network Code
        function getNetworkCode(enqNo) {
            if (!enqNo) return 'UP100003';
            // Typical format: VEHENQ-UP100003-1-2526-11269
            const parts = enqNo.split('-');
            
            // Check if 2nd part exists and starts with 'UP' (indicating a network code)
            if (parts.length > 1 && parts[1] && parts[1].toUpperCase().startsWith('UP')) {
                return parts[1].toUpperCase();
            }
            
            // Fallback for error formats (e.g., 1-147910687879) as requested
            return 'UP100003';
        }

        function generateReport() {
            const input = document.getElementById('csvInput').value.trim();
            const showNetwork = document.getElementById('showNetwork').checked;
            
            const errorDiv = document.getElementById('errorMsg');
            const debugDiv = document.getElementById('debugInfo');
            
            errorDiv.classList.add('hidden');
            debugDiv.classList.add('hidden');
            
            if (!input) { alert("Please paste data!"); return; }

            const lines = input.split('\n').filter(l => l.trim() !== '');
            if (lines.length < 2) { alert("Not enough rows."); return; }

            // Delimiter Detection
            const firstLine = lines[0];
            let delimiter = ',';
            if (firstLine.includes('\t')) delimiter = '\t';
            else if (firstLine.split(';').length > 5) delimiter = ';';

            const headers = parseRow(lines[0], delimiter).map(h => h.toLowerCase());

            const varResult = getColumnIndex(headers, ['model variant', 'variant', 'model name']);
            const colVariant = varResult.index;
            const enqResult = getColumnIndex(headers, ['enquiry number', 'enq no', 'enquiry no', 'enq id']);
            const colEnqNo = enqResult.index;
            const dateResult = getColumnIndex(headers, ['enquiry created date', 'created date', 'created on', 'date of enquiry']);
            let colDate = dateResult.index;

            if (colDate === -1) {
                const fallbackDate = getColumnIndex(headers, ['date']);
                colDate = fallbackDate.index;
            }

            if (colVariant === -1 || colEnqNo === -1 || colDate === -1) {
                alert(`Columns not found!\nVariant: ${colVariant > -1 ? 'âœ…' : 'âŒ'}\nEnquiry No: ${colEnqNo > -1 ? 'âœ…' : 'âŒ'}\nDate: ${colDate > -1 ? 'âœ…' : 'âŒ'}\n\nPlease check headers.`);
                return;
            }

            debugDiv.innerText = `Detected Columns -> Variant: "${headers[colVariant]}", Enquiry No: "${headers[colEnqNo]}", Date: "${headers[colDate]}"`;
            debugDiv.classList.remove('hidden');

            let pivotData = {}; 
            let allDatesMap = new Map();
            let allKeys = new Set();
            let validRows = 0;
            let skippedRows = 0;

            for (let i = 1; i < lines.length; i++) {
                let row = parseRow(lines[i], delimiter);

                if (!row[colVariant] || !row[colEnqNo]) { skippedRows++; continue; }

                let variant = row[colVariant].trim();
                let enqNo = row[colEnqNo].trim();
                let rawDate = row[colDate] ? row[colDate].trim() : '';

                // --- CLEANING VARIANT ---
                variant = variant.replace(/(\s+|-)?OBD2[B]?[0-9]*\b/gi, '').trim();
                let vUpper = variant.toUpperCase();
                if (vUpper.includes("SP125") && (vUpper.includes("DLX DC") || vUpper.includes("DLX DISK") || vUpper.includes("DISK"))) {
                    variant = "SP125 DISK";
                } else if (vUpper.includes("SP125") && (vUpper.includes("DRUM") || vUpper.includes("STD DR"))) {
                    variant = "SP125 DRUM";
                } else if (vUpper.includes("SHINE 125") && (vUpper.includes("DISC") || vUpper.includes("DISK"))) {
                    variant = "SHINE 125 DISC";
                }

                // --- DATE PARSING ---
                let dateObj = formatDate(rawDate);
                if (!dateObj) { skippedRows++; continue; }

                validRows++;
                if (!allDatesMap.has(dateObj.label)) {
                    allDatesMap.set(dateObj.label, dateObj.iso);
                }

                // --- KEY GENERATION (Network vs Normal) ---
                let key;
                if (showNetwork) {
                    let netCode = getNetworkCode(enqNo);
                    // Use a separator that won't appear in data
                    key = `${netCode}###${variant}`; 
                } else {
                    key = variant;
                }
                
                allKeys.add(key);

                if (!pivotData[key]) pivotData[key] = {};
                if (!pivotData[key][dateObj.label]) pivotData[key][dateObj.label] = new Set();
                pivotData[key][dateObj.label].add(enqNo);
            }

            if (validRows === 0) {
                errorDiv.innerText = `Error: 0 rows processed! ${skippedRows} rows skipped.\nCheck Date format.`;
                errorDiv.classList.remove('hidden');
                document.getElementById('outputSection').classList.remove('hidden');
                return;
            }

            // Sorting
            const sortedDates = Array.from(allDatesMap.keys()).sort((a, b) => allDatesMap.get(a) - allDatesMap.get(b));
            
            // Sort Keys
            const sortedKeys = Array.from(allKeys).sort((a, b) => {
                if (showNetwork) {
                    // Split key back to NetCode and Variant
                    let [netA, varA] = a.split('###');
                    let [netB, varB] = b.split('###');
                    if (netA !== netB) return netA.localeCompare(netB);
                    return varA.localeCompare(varB);
                }
                return a.localeCompare(b);
            });

            // Build Grid
            finalGrid = [];
            
            // Header Construction
            let headerRow = [];
            if (showNetwork) {
                headerRow = ['Network Code', 'Model Variant', ...sortedDates, 'Grand Total'];
            } else {
                headerRow = ['Model Variant', ...sortedDates, 'Grand Total'];
            }
            finalGrid.push(headerRow);

            let colTotals = new Array(sortedDates.length).fill(0);
            let grandTotalAll = 0;

            sortedKeys.forEach(key => {
                let rowDisplay = [];
                if (showNetwork) {
                    let parts = key.split('###');
                    rowDisplay = [parts[0], parts[1]]; // [NetCode, Variant]
                } else {
                    rowDisplay = [key]; // [Variant]
                }

                let rowCounts = [];
                let rowTotal = 0;
                
                sortedDates.forEach((date, idx) => {
                    let count = pivotData[key][date] ? pivotData[key][date].size : 0;
                    rowCounts.push(count === 0 ? '' : count);
                    if (count > 0) { rowTotal += count; colTotals[idx] += count; }
                });

                finalGrid.push([...rowDisplay, ...rowCounts, rowTotal]);
                grandTotalAll += rowTotal;
            });

            // Footer
            let footerLabel = showNetwork ? ['Grand Total', ''] : ['Grand Total'];
            let footerRow = [...footerLabel, ...colTotals.map(t => t === 0 ? '' : t), grandTotalAll];
            finalGrid.push(footerRow);

            renderTable(finalGrid, showNetwork, validRows);
        }

        function renderTable(grid, isNetworkWise, validCount) {
            const table = document.getElementById('reportTable');
            table.innerHTML = '';
            
            // Header
            const thead = document.createElement('thead');
            const trHead = document.createElement('tr');
            grid[0].forEach((cell, i) => {
                const th = document.createElement('th');
                th.className = "px-4 py-3 font-semibold text-xs uppercase border-b border-gray-200 whitespace-nowrap";
                
                // Sticky Logic
                if (i === 0) th.className += " sticky-col-1 bg-gray-800 text-white border-r-0";
                if (isNetworkWise && i === 1) {
                    th.className += " sticky-col-2 bg-gray-800 text-white border-r-0";
                    th.style.left = "120px"; // Approximate width of network col
                } else {
                    if(!isNetworkWise && i===0) th.style.left = "0";
                    else if (isNetworkWise && i===0) th.style.left = "0";
                }
                
                th.innerText = cell;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);
            table.appendChild(thead);

            // Body
            const tbody = document.createElement('tbody');
            for (let i = 1; i < grid.length - 1; i++) {
                const tr = document.createElement('tr');
                tr.className = i % 2 === 0 ? "bg-gray-50 hover:bg-yellow-50" : "bg-white hover:bg-yellow-50";
                grid[i].forEach((cell, j) => {
                    const tag = (j === 0 || (isNetworkWise && j === 1)) ? 'th' : 'td';
                    const el = document.createElement(tag);
                    el.className = "px-4 py-2 border-b border-gray-200 whitespace-nowrap";
                    
                    if (j === 0) el.className += " font-medium text-gray-900 border-r bg-gray-50 sticky-col-1";
                    if (isNetworkWise && j === 1) {
                        el.className += " font-medium text-gray-900 border-r bg-gray-50 sticky-col-2";
                        el.style.left = "120px";
                    }

                    if (j > (isNetworkWise ? 1 : 0)) el.className += " text-center";
                    if (j === grid[i].length - 1) el.className += " font-bold text-blue-600 bg-blue-50"; 
                    
                    el.innerText = cell;
                    tr.appendChild(el);
                });
                tbody.appendChild(tr);
            }

            // Footer
            const tfoot = document.createElement('tfoot');
            const trFoot = document.createElement('tr');
            trFoot.className = "bg-gray-800 text-white font-bold";
            grid[grid.length - 1].forEach((cell, j) => {
                const td = document.createElement('td');
                td.className = "px-4 py-3 text-center border-t border-gray-300";
                
                // Sticky Footer Left
                if (j === 0) {
                     td.className += " text-left sticky left-0 bg-gray-800 z-10 sticky-col-1";
                     if (isNetworkWise) td.setAttribute("colspan", 2);
                } else if (isNetworkWise && j === 1) {
                    return; // Skip 2nd cell as first has colspan
                }
                
                td.innerText = cell;
                trFoot.appendChild(td);
            });
            tfoot.appendChild(trFoot);
            table.appendChild(tfoot);

            document.getElementById('outputSection').classList.remove('hidden');
            document.getElementById('stats').innerText = `Processed ${validCount} rows successfully.`;
        }

        function clearInput() {
            document.getElementById('csvInput').value = '';
            document.getElementById('outputSection').classList.add('hidden');
            document.getElementById('errorMsg').classList.add('hidden');
            document.getElementById('debugInfo').classList.add('hidden');
        }

        function exportCSV() {
            if (finalGrid.length === 0) return;
            let csvContent = "data:text/csv;charset=utf-8," + finalGrid.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Enquiry_Matrix_Report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function copyTable() {
            if (finalGrid.length === 0) return;
            let tsvContent = finalGrid.map(e => e.join("\t")).join("\n");
            navigator.clipboard.writeText(tsvContent).then(() => {
                const btn = document.querySelector('button[onclick="copyTable()"]');
                const originalText = btn.innerHTML;
                btn.innerHTML = "âœ… Copied!";
                setTimeout(() => { btn.innerHTML = originalText; }, 2000);
            });
        }
    </script>
</body>
</html>
