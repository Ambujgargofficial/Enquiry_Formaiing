<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Matrix Report Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .table-wrapper {
            max-height: 600px; /* Table scrollable height */
            overflow: auto;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            background-color: white;
        }
        
        /* Spreadsheet Style Table */
        table {
            border-collapse: separate; 
            border-spacing: 0;
            width: 100%;
            font-size: 13px;
        }
        th, td {
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            padding: 8px 12px;
            white-space: nowrap;
        }

        /* Sticky Headers */
        thead th {
            position: sticky;
            top: 0;
            background-color: #f3f4f6;
            color: #111827;
            z-index: 20;
            border-bottom: 2px solid #9ca3af;
            font-weight: 700;
        }

        /* Sticky Columns */
        .sticky-col-1 { 
            position: sticky; 
            left: 0; 
            z-index: 10; 
            background-color: #f9fafb; 
            border-right: 2px solid #d1d5db; 
        }
        .sticky-col-2 { 
            position: sticky; 
            left: 100px; /* Adjusted via JS */
            z-index: 10; 
            background-color: #f9fafb; 
            border-right: 2px solid #d1d5db;
        }
        
        thead th.sticky-col-1 { z-index: 30; }
        thead th.sticky-col-2 { z-index: 30; }
        
        /* Footer Styling */
        tfoot td {
            background-color: #fffbeb; 
            font-weight: bold;
            position: sticky;
            bottom: 0;
            z-index: 20;
            border-top: 2px solid #9ca3af;
            color: #92400e;
        }
        tfoot td.sticky-col-1 { z-index: 30; background-color: #fde68a; }

        tbody tr:hover td { background-color: #eff6ff; }

        /* --- Creator & Contact Styles (From Game) --- */
        .creator-container {
            display: flex; flex-direction: row; align-items: center;
            justify-content: center; gap: 10px;
            background: #111; /* Dark background so neon pops on light tool */
            padding: 6px 15px;
            border-radius: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .creator-text {
            font-size: 14px; font-family: 'Brush Script MT', cursive;
            background: linear-gradient(90deg, #00ffff, #39ff14);
            -webkit-background-clip: text; background-clip: text; color: transparent;
            text-shadow: 0 0 8px rgba(57, 255, 20, 0.3); letter-spacing: 1px;
            opacity: 0.9; animation: pulse 3s infinite;
            margin: 0;
        }
        @keyframes pulse { 0% { text-shadow: 0 0 5px rgba(57, 255, 20, 0.3); } 50% { text-shadow: 0 0 15px rgba(0, 255, 255, 0.6); } }

        .info-btn {
            width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;
            color: white; background: transparent; font-family: 'Verdana', sans-serif;
            font-weight: bold; font-size: 12px; cursor: pointer;
            display: flex; align-items: center; justify-content: center; transition: all 0.3s;
            box-shadow: 0 0 5px rgba(255,255,255,0.5);
            text-decoration: none;
        }
        .info-btn:hover { background: white; color: black; box-shadow: 0 0 10px white; }

        /* Overlay */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 10, 0.98);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100;
        }
        .menu-box {
            background: rgba(20, 20, 20, 0.9);
            border: 2px solid #00ffff; /* Neon Blue Border */
            box-shadow: 0 0 30px #00ffff;
            padding: 20px; border-radius: 15px;
            text-align: center; width: 90%; max-width: 320px; position: relative;
        }
        .developer-name {
            font-size: 18px; font-weight: bold;
            background: linear-gradient(45deg, #ff0000, #ff7300, #fffb00, #48ff00, #00ffd5, #002bff, #7a00ff, #ff00c8, #ff0000);
            background-size: 400%; -webkit-background-clip: text; color: transparent;
            animation: glowing 10s linear infinite; margin-bottom: 20px; display: inline-block;
        }
        @keyframes glowing { 0% {background-position: 0 0;} 100% {background-position: 400% 0;} }

        .social-btn {
            display: flex; align-items: center; justify-content: center; gap: 10px;
            width: 100%; padding: 10px; margin: 8px 0;
            border-radius: 8px; text-decoration: none; font-weight: bold; color: white;
            transition: transform 0.2s; box-sizing: border-box;
            font-family: sans-serif;
        }
        .social-btn:active { transform: scale(0.95); }
        .whatsapp-btn { background: #25D366; box-shadow: 0 0 10px rgba(37, 211, 102, 0.4); }
        .email-btn { background: #EA4335; box-shadow: 0 0 10px rgba(234, 67, 53, 0.4); }
        .insta-btn { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); box-shadow: 0 0 10px rgba(220, 39, 67, 0.4); }
        .close-contact { margin-top: 15px; background: #333; color: white; border: 1px solid #555; padding: 8px 20px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body class="p-6">

    <!-- Contact Overlay (Hidden by default) -->
    <div id="contact-screen" class="overlay">
        <div class="menu-box">
            <h2 style="color:white; margin-top:0; font-family: sans-serif;">Developer Info</h2>
            
            <div class="developer-name">‚ú® Ambuj Garg ‚ú®</div>
            
            <a href="https://wa.me/917017024586" target="_blank" class="social-btn whatsapp-btn">
                <span style="font-size:20px">üí¨</span> Chat on WhatsApp
            </a>

            <a href="mailto:ambujgarg.2011@rediffmail.com" class="social-btn email-btn">
                <span style="font-size:20px">‚úâÔ∏è</span> Email Us
            </a>
            
            <a href="https://www.instagram.com/ambujgarg_official?igsh=NHF3aGw2M3E3OTln" target="_blank" class="social-btn insta-btn">
                <span style="font-size:20px">üì∏</span> Follow on Instagram
            </a>

            <button class="close-contact" onclick="hideContact()">Close</button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <!-- Header Row with Creator Badge -->
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">üìä Universal Matrix Report</h1>
                <p class="text-xs text-gray-500 mt-1">(Enquiry & Invoice)</p>
            </div>
            
            <!-- Creator Badge inserted here -->
            <div class="creator-container">
                <div class="creator-text">Created By : Ambuj Garg</div>
                <button class="info-btn" onclick="showContact()">i</button>
            </div>
        </div>

        <p class="text-sm text-gray-600 mb-4">
            Paste your raw CSV/Excel data below. <<-----Ambujgarg_official<br>
            This automatically detects if it's an <b>Enquiry Report</b> or <b>Invoice Report</b>).
        </p>

        <!-- Input Section (Big Box) -->
        <textarea id="csvInput" class="w-full h-48 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-xs font-mono" placeholder="Paste data here..."></textarea>
        
        <div class="flex flex-wrap items-center gap-4 mt-4">
            <button onclick="parseAndGenerate()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-medium transition shadow-sm">
                Generate Report
            </button>
            <button onclick="clearInput()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded font-medium transition">
                Clear
            </button>
            
            <div class="flex items-center gap-2 ml-4 border-l pl-4 border-gray-300">
                <input type="checkbox" id="showNetwork" onchange="updateDisplay()" class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
                <label for="showNetwork" class="text-sm font-semibold text-gray-700 select-none cursor-pointer">Show Network Wise</label>
            </div>

            <!-- Filters Container (Initially Hidden) -->
            <div id="filterContainer" class="hidden flex flex-wrap items-center gap-4 ml-4 border-l pl-4 border-gray-300">
                <!-- Network Filter -->
                <div class="flex items-center gap-2">
                    <label for="networkFilter" class="text-sm font-semibold text-gray-700">Network:</label>
                    <select id="networkFilter" onchange="updateDisplay()" class="text-sm border border-gray-300 rounded p-1 focus:ring-blue-500 bg-white max-w-[200px]">
                        <option value="ALL">All Networks (Sum)</option>
                        <option value="SEPARATE" class="font-bold text-blue-700">Show All Separate</option>
                    </select>
                </div>
                <!-- Model Filter -->
                <div class="flex items-center gap-2">
                    <label for="modelFilter" class="text-sm font-semibold text-gray-700">Model:</label>
                    <select id="modelFilter" onchange="updateDisplay()" class="text-sm border border-gray-300 rounded p-1 focus:ring-blue-500 bg-white max-w-[150px]">
                        <option value="ALL">All Models</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Status & Debug Messages -->
        <div id="statusMsg" class="mt-3 text-sm font-medium h-5 text-blue-600"></div>

        <!-- Output Section (Initially Hidden) -->
        <div id="outputSection" class="hidden mt-6 border-t pt-6">
            <div class="flex justify-between items-center mb-3">
                <!-- Dynamic Title Here -->
                <h2 id="reportTitle" class="text-lg font-bold text-gray-700">Report Preview (All)</h2>
                <div class="flex gap-2">
                    <button onclick="copyTable()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded text-sm transition flex items-center gap-1 shadow-sm">
                        <span>üìã</span> Copy
                    </button>
                    <button onclick="exportCSV()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1.5 rounded text-sm transition flex items-center gap-1 shadow-sm">
                        <span>üì•</span> Download CSV
                    </button>
                </div>
            </div>

            <div class="table-wrapper">
                <table id="reportTable" class="text-sm text-left text-gray-700">
                    <!-- Data injected here -->
                </table>
            </div>
            <div id="stats" class="mt-2 text-xs text-gray-500 text-right font-medium"></div>
        </div>
    </div>

    <script>
        let finalGrid = []; 
        let globalParsedData = []; 
        let currentReportType = 'ENQUIRY'; // 'ENQUIRY' or 'INVOICE'

        // --- Creator Info Functions ---
        function showContact() { document.getElementById('contact-screen').style.display = 'flex'; }
        function hideContact() { document.getElementById('contact-screen').style.display = 'none'; }

        function parseRow(text, delimiter) {
            if (delimiter === '\t') return text.split('\t').map(c => c.trim().replace(/^"|"$/g, ''));
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') { inQuotes = !inQuotes; } 
                else if (char === delimiter && !inQuotes) {
                    result.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else { current += char; }
            }
            result.push(current.trim().replace(/^"|"$/g, ''));
            return result;
        }

        function formatDate(dateStr) {
            if (!dateStr) return null;
            let parts = dateStr.trim().split(/[\-\/\s\.]+/); 
            parts = parts.filter(p => p.length > 0 && !isNaN(p));
            if (parts.length < 3) return null;

            let p1 = parseInt(parts[0]);
            let p2 = parseInt(parts[1]);
            let p3 = parseInt(parts[2]); 

            let day, month, year;
            if (p3 > 1000) { day = p1; month = p2 - 1; year = p3; } 
            else if (p1 > 1000) { year = p1; month = p2 - 1; day = p3; } 
            else { if (p3 < 100) p3 += 2000; day = p1; month = p2 - 1; year = p3; } 

            if (month < 0 || month > 11 || day < 1 || day > 31) return null;
            const d = new Date(year, month, day);
            if (isNaN(d.getTime())) return null;

            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            return {
                iso: d.getTime(), 
                label: `${day < 10 ? '0'+day : day}-${months[month]}` 
            };
        }

        function getColumnIndex(headers, keywords) {
            for (const keyword of keywords) {
                const index = headers.findIndex(h => h.includes(keyword));
                if (index !== -1) return { index, keyword };
            }
            return { index: -1, keyword: null };
        }

        // Logic specifically for extracting code from Enquiry Number string (e.g. VEHENQ-UP100003...)
        function extractCodeFromEnquiryString(enqNo) {
            if (!enqNo) return null;
            const parts = enqNo.split('-');
            if (parts.length > 1 && parts[1] && parts[1].toUpperCase().startsWith('UP')) {
                return parts[1].toUpperCase();
            }
            return null;
        }

        // STEP 1: Parse Data & Logic
        function parseAndGenerate() {
            const input = document.getElementById('csvInput').value.trim();
            const statusDiv = document.getElementById('statusMsg');
            const outputSection = document.getElementById('outputSection');
            
            // Reset
            globalParsedData = [];
            outputSection.classList.add('hidden');
            document.getElementById('filterContainer').classList.add('hidden');
            statusDiv.innerText = "Processing...";
            statusDiv.className = "mt-3 text-sm font-medium text-blue-600 h-5";
            
            if (!input) { 
                alert("Please paste data!"); 
                statusDiv.innerText = "";
                return; 
            }

            const lines = input.split('\n').filter(l => l.trim() !== '');
            if (lines.length < 2) { alert("Not enough rows."); return; }

            const firstLine = lines[0];
            let delimiter = ',';
            if (firstLine.includes('\t')) delimiter = '\t';
            else if (firstLine.split(';').length > 5) delimiter = ';';

            const headers = parseRow(lines[0], delimiter).map(h => h.toLowerCase());

            // --- AUTO DETECTION LOGIC ---
            
            // 1. Identify Common Column (Model Variant)
            const colVariant = getColumnIndex(headers, ['model variant', 'variant', 'model name']).index;

            // 2. Identify Enquiry Columns
            const colEnqNo = getColumnIndex(headers, ['enquiry number', 'enq no', 'enquiry no']).index;
            let colEnqDate = getColumnIndex(headers, ['enquiry created date', 'created date', 'created on']).index;
            if (colEnqDate === -1) colEnqDate = getColumnIndex(headers, ['date']).index;

            // 3. Identify Invoice Columns
            const colInvNo = getColumnIndex(headers, ['invoice #', 'invoice no', 'invoice number']).index;
            const colInvDate = getColumnIndex(headers, ['invoice date']).index;
            const colBillingCode = getColumnIndex(headers, ['billing network code']).index;

            // Decision Matrix
            let colID = -1; // Either Enquiry No or Invoice No
            let colDate = -1; // Either Created Date or Invoice Date
            let colNetSource = -1; // Network Type (Enquiry) or Billing Code (Invoice)
            
            if (colInvNo > -1 && colInvDate > -1) {
                // INVOICE MODE
                currentReportType = 'INVOICE';
                colID = colInvNo;
                colDate = colInvDate;
                colNetSource = colBillingCode; 
            } else if (colEnqNo > -1 && colEnqDate > -1) {
                // ENQUIRY MODE
                currentReportType = 'ENQUIRY';
                colID = colEnqNo;
                colDate = colEnqDate;
                // For Enquiry, we check 'Network Type' to find 'Main Dealer' rows
                colNetSource = getColumnIndex(headers, ['network type', 'dealer type']).index; 
            } else {
                alert("Could not detect data type!\nNeed either:\n1. Enquiry Number + Enquiry Created Date\nOR\n2. Invoice # + Invoice Date");
                statusDiv.innerText = "Error: Unknown data format.";
                statusDiv.className = "mt-3 text-sm font-medium text-red-600 h-5";
                return;
            }

            if (colVariant === -1) {
                alert("Missing 'Model Variant' column.");
                return;
            }

            statusDiv.innerText = `Detected Mode: ${currentReportType}. Parsing...`;

            // --- PASS 1: SCAN FOR DOMINANT DEALER CODE (Mainly for Enquiry Mode Fallback) ---
            let rawData = [];
            let codeCounts = {};
            let mainDealerCode = null;

            for (let i = 1; i < lines.length; i++) {
                let row = parseRow(lines[i], delimiter);
                if (!row[colVariant] || !row[colID]) continue;

                let variant = row[colVariant].trim();
                let uniqueID = row[colID].trim(); // Enq No or Inv No
                let rawDate = row[colDate] ? row[colDate].trim() : '';
                
                let extractedCode = null;

                if (currentReportType === 'INVOICE') {
                    // --- STRICT LOGIC FOR INVOICE ---
                    // Must have a value in Billing Network Code column
                    if (colNetSource === -1 || !row[colNetSource] || row[colNetSource].trim() === '') {
                        continue; // Skip this row entirely
                    }
                    extractedCode = row[colNetSource].trim().toUpperCase();
                } else {
                    // --- LOGIC FOR ENQUIRY ---
                    let netType = (colNetSource > -1 && row[colNetSource]) ? row[colNetSource].trim().toLowerCase() : '';
                    extractedCode = extractCodeFromEnquiryString(uniqueID);
                    
                    if (netType.includes('main dealer') && extractedCode) {
                        mainDealerCode = extractedCode;
                    }
                }
                
                if (extractedCode) {
                    codeCounts[extractedCode] = (codeCounts[extractedCode] || 0) + 1;
                }
                
                rawData.push({ variant, uniqueID, rawDate, extractedCode });
            }

            // Determine Default Code (Used if extraction fails in Enquiry mode)
            let defaultCode = 'UP100003';
            if (currentReportType === 'ENQUIRY') {
                if (mainDealerCode) {
                    defaultCode = mainDealerCode;
                } else {
                    let maxCount = 0;
                    for (const [code, count] of Object.entries(codeCounts)) {
                        if (count > maxCount) {
                            maxCount = count;
                            defaultCode = code;
                        }
                    }
                }
            }

            // --- PASS 2: CLEAN & STORE ---
            let uniqueNetworks = new Set();
            let uniqueModels = new Set();

            for (let rowObj of rawData) {
                let { variant, uniqueID, rawDate, extractedCode } = rowObj;

                // Clean Variant
                variant = variant.replace(/(\s+|-)?OBD2[B]?[0-9]*\b/gi, '').trim();
                let vUpper = variant.toUpperCase();
                if (vUpper.includes("SP125") && (vUpper.includes("DLX DC") || vUpper.includes("DLX DISK") || vUpper.includes("DISK"))) variant = "SP125 DISK";
                else if (vUpper.includes("SP125") && (vUpper.includes("DRUM") || vUpper.includes("STD DR"))) variant = "SP125 DRUM";
                else if (vUpper.includes("SHINE 125") && (vUpper.includes("DISC") || vUpper.includes("DISK"))) variant = "SHINE 125 DISC";

                let dateObj = formatDate(rawDate);
                if (!dateObj) continue;

                // For Invoice, extractedCode is guaranteed. For Enquiry, fallback to default.
                let finalNetCode = extractedCode || defaultCode;
                
                uniqueNetworks.add(finalNetCode);
                uniqueModels.add(variant);

                globalParsedData.push({
                    netCode: finalNetCode,
                    variant: variant,
                    dateLabel: dateObj.label,
                    dateIso: dateObj.iso,
                    id: uniqueID
                });
            }

            if (globalParsedData.length === 0) {
                statusDiv.innerText = "Error: 0 valid rows processed. Check Date formats or Empty Billing Codes.";
                statusDiv.className = "mt-3 text-sm font-medium text-red-600 h-5";
                return;
            }

            // Populate Filters
            const netFilter = document.getElementById('networkFilter');
            netFilter.innerHTML = `
                <option value="ALL">All Networks (Sum)</option>
                <option value="SEPARATE" class="font-bold text-blue-700">Show All Separate</option>
            `;
            Array.from(uniqueNetworks).sort().forEach(code => {
                netFilter.add(new Option(code, code));
            });

            const modFilter = document.getElementById('modelFilter');
            modFilter.innerHTML = '<option value="ALL">All Models</option>';
            Array.from(uniqueModels).sort().forEach(mod => {
                modFilter.add(new Option(mod, mod));
            });

            document.getElementById('filterContainer').classList.remove('hidden');

            if (currentReportType === 'INVOICE') {
                statusDiv.innerHTML = `‚úÖ <b>INVOICE REPORT</b> Generated. Skipped rows with empty Billing Codes.`;
            } else {
                statusDiv.innerHTML = `‚úÖ <b>ENQUIRY REPORT</b> Generated. Default Code: <b>${defaultCode}</b>.`;
            }
            statusDiv.className = "mt-3 text-sm font-medium text-green-700 h-5";

            updateDisplay();
        }

        // STEP 2: Aggregate & Render
        function updateDisplay() {
            if (globalParsedData.length === 0) return;

            const showNetworkCheckbox = document.getElementById('showNetwork').checked;
            const netVal = document.getElementById('networkFilter').value;
            const modVal = document.getElementById('modelFilter').value;
            const outputSection = document.getElementById('outputSection');
            const titleEl = document.getElementById('reportTitle');

            // View Logic
            let isNetworkWiseView = showNetworkCheckbox || (netVal === 'SEPARATE');

            // Title Logic
            let typeLabel = currentReportType === 'ENQUIRY' ? 'Enquiry' : 'Invoice';
            let titleParts = [];
            if (netVal !== 'ALL' && netVal !== 'SEPARATE') titleParts.push(netVal);
            else if (netVal === 'SEPARATE') titleParts.push("All Networks (Sep)");
            
            if (modVal !== 'ALL') titleParts.push(modVal);
            
            let titleSuffix = titleParts.length > 0 ? titleParts.join(' - ') : 'All';
            titleEl.innerText = `${typeLabel} Matrix Preview (${titleSuffix})`;

            // Filtering
            let filteredData = globalParsedData.filter(d => {
                let matchNet = (netVal === 'ALL' || netVal === 'SEPARATE') || (d.netCode === netVal);
                let matchMod = (modVal === 'ALL') || (d.variant === modVal);
                return matchNet && matchMod;
            });

            // Pivot Logic
            let pivotData = {}; 
            let allDatesMap = new Map();
            let allKeys = new Set();

            filteredData.forEach(row => {
                if (!allDatesMap.has(row.dateLabel)) allDatesMap.set(row.dateLabel, row.dateIso);

                let key = isNetworkWiseView ? `${row.netCode}###${row.variant}` : row.variant;
                allKeys.add(key);

                if (!pivotData[key]) pivotData[key] = {};
                if (!pivotData[key][row.dateLabel]) pivotData[key][row.dateLabel] = new Set();
                pivotData[key][row.dateLabel].add(row.id);
            });

            // Sorting
            const sortedDates = Array.from(allDatesMap.keys()).sort((a, b) => allDatesMap.get(a) - allDatesMap.get(b));
            const sortedKeys = Array.from(allKeys).sort((a, b) => {
                if (isNetworkWiseView) {
                    let [netA, varA] = a.split('###');
                    let [netB, varB] = b.split('###');
                    if (netA !== netB) return netA.localeCompare(netB);
                    return varA.localeCompare(varB);
                }
                return a.localeCompare(b);
            });

            // Build Grid
            finalGrid = [];
            let headerRow = isNetworkWiseView 
                ? ['Network Code', 'Model Variant', ...sortedDates, 'Grand Total'] 
                : ['Model Variant', ...sortedDates, 'Grand Total'];
            finalGrid.push(headerRow);

            let colTotals = new Array(sortedDates.length).fill(0);
            let grandTotalAll = 0;

            sortedKeys.forEach(key => {
                let rowDisplay = isNetworkWiseView ? key.split('###') : [key];
                let rowCounts = [];
                let rowTotal = 0;
                sortedDates.forEach((date, idx) => {
                    let count = pivotData[key][date] ? pivotData[key][date].size : 0;
                    rowCounts.push(count === 0 ? '' : count);
                    if (count > 0) { rowTotal += count; colTotals[idx] += count; }
                });
                finalGrid.push([...rowDisplay, ...rowCounts, rowTotal]);
                grandTotalAll += rowTotal;
            });

            let footerLabel = isNetworkWiseView ? ['Grand Total', ''] : ['Grand Total'];
            finalGrid.push([...footerLabel, ...colTotals.map(t => t === 0 ? '' : t), grandTotalAll]);

            renderTable(finalGrid, isNetworkWiseView);
            
            outputSection.classList.remove('hidden');
            document.getElementById('stats').innerText = `Displaying ${filteredData.length} entries.`;
        }

        function renderTable(grid, isNetworkWise) {
            const table = document.getElementById('reportTable');
            table.innerHTML = '';
            
            const thead = document.createElement('thead');
            const trHead = document.createElement('tr');
            grid[0].forEach((cell, i) => {
                const th = document.createElement('th');
                if (i === 0) th.className = "sticky-col-1";
                if (isNetworkWise && i === 1) {
                    th.className = "sticky-col-2";
                    th.style.left = "110px"; 
                }
                th.innerText = cell;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            for (let i = 1; i < grid.length - 1; i++) {
                const tr = document.createElement('tr');
                grid[i].forEach((cell, j) => {
                    const tag = (j === 0 || (isNetworkWise && j === 1)) ? 'th' : 'td';
                    const el = document.createElement(tag);
                    
                    if (j === 0) el.className = "sticky-col-1 text-left bg-gray-50 font-medium text-gray-900";
                    if (isNetworkWise && j === 1) {
                        el.className = "sticky-col-2 text-left bg-gray-50 font-medium text-gray-900";
                        el.style.left = "110px";
                    }
                    if (j > (isNetworkWise ? 1 : 0)) el.className = "text-center";
                    if (j === grid[i].length - 1) el.className += " font-bold bg-blue-50 text-blue-700";
                    
                    el.innerText = cell;
                    tr.appendChild(el);
                });
                tbody.appendChild(tr);
            }
            table.appendChild(tbody);

            const tfoot = document.createElement('tfoot');
            const trFoot = document.createElement('tr');
            const lastRow = grid[grid.length - 1];
            lastRow.forEach((cell, j) => {
                const td = document.createElement('td');
                td.className = "text-center";
                if (j === 0) {
                     td.className += " text-left sticky-col-1";
                     if (isNetworkWise) td.setAttribute("colspan", 2);
                } else if (isNetworkWise && j === 1) {
                    return; 
                }
                td.innerText = cell;
                trFoot.appendChild(td);
            });
            tfoot.appendChild(trFoot);
            table.appendChild(tfoot);
        }

        function clearInput() {
            document.getElementById('csvInput').value = '';
            document.getElementById('outputSection').classList.add('hidden');
            document.getElementById('filterContainer').classList.add('hidden');
            document.getElementById('statusMsg').innerText = '';
            globalParsedData = [];
        }

        function exportCSV() {
            if (finalGrid.length === 0) return;
            
            const netVal = document.getElementById('networkFilter').value;
            const modVal = document.getElementById('modelFilter').value;
            
            let nameParts = [];
            if (netVal === 'SEPARATE') nameParts.push('All_Networks_Sep');
            else if (netVal !== 'ALL') nameParts.push(netVal);
            
            if (modVal !== 'ALL') nameParts.push(modVal.replace(/[^a-z0-9]/gi, '_')); 
            
            let suffix = nameParts.length > 0 ? nameParts.join('_') : 'All';
            let typePrefix = currentReportType === 'ENQUIRY' ? 'Enquiry' : 'Invoice';

            let csvContent = "data:text/csv;charset=utf-8," + finalGrid.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${typePrefix}_Matrix_Report_${suffix}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function copyTable() {
            if (finalGrid.length === 0) return;
            let tsvContent = finalGrid.map(e => e.join("\t")).join("\n");
            navigator.clipboard.writeText(tsvContent).then(() => { alert("Copied to clipboard!"); });
        }
    </script>
</body>
</html>
