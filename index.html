<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enquiry Matrix Report Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .table-wrapper {
            max-height: 600px; /* Table scrollable rahegi */
            overflow: auto;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            background-color: white;
            margin-top: 1rem;
        }
        
        /* Spreadsheet Style Table */
        table {
            border-collapse: separate; 
            border-spacing: 0;
            width: 100%;
            font-size: 13px;
        }
        th, td {
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            padding: 8px 12px;
            white-space: nowrap;
        }

        /* Sticky Headers */
        thead th {
            position: sticky;
            top: 0;
            background-color: #f3f4f6;
            color: #111827;
            z-index: 20;
            border-bottom: 2px solid #9ca3af;
            font-weight: 700;
        }

        /* Sticky Columns */
        .sticky-col-1 { 
            position: sticky; 
            left: 0; 
            z-index: 10; 
            background-color: #f9fafb; 
            border-right: 2px solid #d1d5db; 
        }
        .sticky-col-2 { 
            position: sticky; 
            left: 100px; 
            z-index: 10; 
            background-color: #f9fafb; 
            border-right: 2px solid #d1d5db;
        }
        
        thead th.sticky-col-1 { z-index: 30; }
        thead th.sticky-col-2 { z-index: 30; }
        
        /* Footer Styling */
        tfoot td {
            background-color: #fffbeb; 
            font-weight: bold;
            position: sticky;
            bottom: 0;
            z-index: 20;
            border-top: 2px solid #9ca3af;
            color: #92400e;
        }
        tfoot td.sticky-col-1 { z-index: 30; background-color: #fde68a; }

        tbody tr:hover td { background-color: #eff6ff; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-7xl mx-auto bg-white p-6 rounded-lg shadow-lg">
        <h1 class="text-2xl font-bold mb-4 text-gray-800">ðŸ“Š Daily Enquiry Matrix Report</h1>
        <p class="text-sm text-gray-600 mb-2">Paste your raw CSV data below.  <<------ : @Ambujgarg_official </p>

        <!-- Input Section (Wapas Bada Box) -->
        <textarea id="csvInput" class="w-full h-48 p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 text-xs font-mono" placeholder="Paste CSV/Excel data here... (Headers: Model Variant, Enquiry Number, Enquiry Created Date, Network Type)"></textarea>
        
        <div class="flex flex-wrap items-center gap-4 mt-4">
            <button onclick="generateReport()" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded font-medium transition shadow-sm">
                Generate Report
            </button>
            <button onclick="clearInput()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded font-medium transition">
                Clear
            </button>
            
            <div class="flex items-center gap-2 ml-4 border-l pl-4 border-gray-300">
                <input type="checkbox" id="showNetwork" class="w-5 h-5 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
                <label for="showNetwork" class="text-sm font-semibold text-gray-700 select-none cursor-pointer">Show Network Wise</label>
            </div>
        </div>

        <!-- Debug Info -->
        <div id="statusMsg" class="mt-3 text-sm font-medium h-5"></div>
        <div id="debugInfo" class="hidden mt-2 text-xs text-blue-700 bg-blue-50 p-2 rounded border border-blue-200 font-mono"></div>

        <!-- Output Section (Initially Hidden) -->
        <div id="outputSection" class="hidden mt-6 border-t pt-6">
            <div class="flex justify-between items-center mb-3">
                <h2 class="text-lg font-bold text-gray-700">Report Preview</h2>
                <div class="flex gap-2">
                    <button onclick="copyTable()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-1.5 rounded text-sm transition flex items-center gap-1 shadow-sm">
                        <span>ðŸ“‹</span> Copy
                    </button>
                    <button onclick="exportCSV()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-1.5 rounded text-sm transition flex items-center gap-1 shadow-sm">
                        <span>ðŸ“¥</span> Download CSV
                    </button>
                </div>
            </div>

            <div id="errorMsg" class="hidden p-3 mb-4 text-sm text-red-700 bg-red-100 rounded-lg border border-red-200" role="alert"></div>

            <div class="table-wrapper">
                <table id="reportTable" class="text-sm text-left text-gray-700">
                    <!-- Data injected here -->
                </table>
            </div>
            <div id="stats" class="mt-2 text-xs text-gray-500 text-right font-medium"></div>
        </div>
    </div>

    <script>
        let finalGrid = []; 

        function parseRow(text, delimiter) {
            if (delimiter === '\t') return text.split('\t').map(c => c.trim().replace(/^"|"$/g, ''));
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') { inQuotes = !inQuotes; } 
                else if (char === delimiter && !inQuotes) {
                    result.push(current.trim().replace(/^"|"$/g, ''));
                    current = '';
                } else { current += char; }
            }
            result.push(current.trim().replace(/^"|"$/g, ''));
            return result;
        }

        function formatDate(dateStr) {
            if (!dateStr) return null;
            let parts = dateStr.trim().split(/[\-\/\s\.]+/); 
            parts = parts.filter(p => p.length > 0 && !isNaN(p));
            if (parts.length < 3) return null;

            let p1 = parseInt(parts[0]);
            let p2 = parseInt(parts[1]);
            let p3 = parseInt(parts[2]); 

            let day, month, year;
            if (p3 > 1000) { day = p1; month = p2 - 1; year = p3; } 
            else if (p1 > 1000) { year = p1; month = p2 - 1; day = p3; } 
            else { if (p3 < 100) p3 += 2000; day = p1; month = p2 - 1; year = p3; } 

            if (month < 0 || month > 11 || day < 1 || day > 31) return null;
            const d = new Date(year, month, day);
            if (isNaN(d.getTime())) return null;

            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            return {
                iso: d.getTime(), 
                label: `${day < 10 ? '0'+day : day}-${months[month]}` 
            };
        }

        function getColumnIndex(headers, keywords) {
            for (const keyword of keywords) {
                const index = headers.findIndex(h => h.includes(keyword));
                if (index !== -1) return { index, keyword };
            }
            return { index: -1, keyword: null };
        }

        function tryExtractCode(enqNo) {
            if (!enqNo) return null;
            const parts = enqNo.split('-');
            if (parts.length > 1 && parts[1] && parts[1].toUpperCase().startsWith('UP')) {
                return parts[1].toUpperCase();
            }
            return null;
        }

        function generateReport() {
            const input = document.getElementById('csvInput').value.trim();
            const showNetwork = document.getElementById('showNetwork').checked;
            const statusDiv = document.getElementById('statusMsg');
            const errorDiv = document.getElementById('errorMsg');
            const outputSection = document.getElementById('outputSection');

            // Reset UI
            statusDiv.innerHTML = "Processing...";
            statusDiv.className = "mt-3 text-sm font-medium text-blue-600 h-5";
            errorDiv.classList.add('hidden');
            outputSection.classList.add('hidden');
            
            if (!input) { 
                alert("Please paste data!"); 
                statusDiv.innerHTML = "";
                return; 
            }

            const lines = input.split('\n').filter(l => l.trim() !== '');
            if (lines.length < 2) { alert("Not enough rows."); return; }

            const firstLine = lines[0];
            let delimiter = ',';
            if (firstLine.includes('\t')) delimiter = '\t';
            else if (firstLine.split(';').length > 5) delimiter = ';';

            const headers = parseRow(lines[0], delimiter).map(h => h.toLowerCase());

            const colVariant = getColumnIndex(headers, ['model variant', 'variant', 'model name']).index;
            const colEnqNo = getColumnIndex(headers, ['enquiry number', 'enq no', 'enquiry no']).index;
            
            let dateRes = getColumnIndex(headers, ['enquiry created date', 'created date', 'created on']);
            let colDate = dateRes.index;
            if (colDate === -1) colDate = getColumnIndex(headers, ['date']).index;

            const colNetType = getColumnIndex(headers, ['network type', 'dealer type']).index;

            if (colVariant === -1 || colEnqNo === -1 || colDate === -1) {
                alert(`Missing Columns! Variant: ${colVariant>-1}, EnqNo: ${colEnqNo>-1}, Date: ${colDate>-1}`);
                statusDiv.innerHTML = "Error: Missing columns.";
                statusDiv.className = "mt-3 text-sm font-medium text-red-600 h-5";
                return;
            }

            // --- DATA PARSING & CODE DETECTION ---
            let parsedRows = [];
            let codeCounts = {};
            let mainDealerCode = null;

            for (let i = 1; i < lines.length; i++) {
                let row = parseRow(lines[i], delimiter);
                if (!row[colVariant] || !row[colEnqNo]) continue;

                let variant = row[colVariant].trim();
                let enqNo = row[colEnqNo].trim();
                let rawDate = row[colDate] ? row[colDate].trim() : '';
                let netType = (colNetType > -1 && row[colNetType]) ? row[colNetType].trim().toLowerCase() : '';

                let extractedCode = tryExtractCode(enqNo);
                
                // Logic: Capture Main Dealer Code
                if (netType.includes('main dealer') && extractedCode) {
                    mainDealerCode = extractedCode;
                }
                
                if (extractedCode) {
                    codeCounts[extractedCode] = (codeCounts[extractedCode] || 0) + 1;
                }
                
                parsedRows.push({ variant, enqNo, rawDate, extractedCode });
            }

            let defaultCode = 'UP100003';
            if (mainDealerCode) {
                defaultCode = mainDealerCode;
            } else {
                let maxCount = 0;
                for (const [code, count] of Object.entries(codeCounts)) {
                    if (count > maxCount) {
                        maxCount = count;
                        defaultCode = code;
                    }
                }
            }

            // --- PIVOT LOGIC ---
            let pivotData = {}; 
            let allDatesMap = new Map();
            let allKeys = new Set();
            let validRows = 0;

            for (let rowObj of parsedRows) {
                let { variant, enqNo, rawDate, extractedCode } = rowObj;

                // Clean Variant
                variant = variant.replace(/(\s+|-)?OBD2[B]?[0-9]*\b/gi, '').trim();
                let vUpper = variant.toUpperCase();
                if (vUpper.includes("SP125") && (vUpper.includes("DLX DC") || vUpper.includes("DLX DISK") || vUpper.includes("DISK"))) variant = "SP125 DISK";
                else if (vUpper.includes("SP125") && (vUpper.includes("DRUM") || vUpper.includes("STD DR"))) variant = "SP125 DRUM";
                else if (vUpper.includes("SHINE 125") && (vUpper.includes("DISC") || vUpper.includes("DISK"))) variant = "SHINE 125 DISC";

                let dateObj = formatDate(rawDate);
                if (!dateObj) continue;

                validRows++;
                if (!allDatesMap.has(dateObj.label)) allDatesMap.set(dateObj.label, dateObj.iso);

                let finalNetCode = extractedCode || defaultCode;
                let key = showNetwork ? `${finalNetCode}###${variant}` : variant;
                allKeys.add(key);

                if (!pivotData[key]) pivotData[key] = {};
                if (!pivotData[key][dateObj.label]) pivotData[key][dateObj.label] = new Set();
                pivotData[key][dateObj.label].add(enqNo);
            }

            if (validRows === 0) {
                statusDiv.innerHTML = "";
                errorDiv.innerText = "Error: 0 valid rows processed. Check Date formats.";
                errorDiv.classList.remove('hidden');
                outputSection.classList.remove('hidden');
                return;
            }

            // Sorting
            const sortedDates = Array.from(allDatesMap.keys()).sort((a, b) => allDatesMap.get(a) - allDatesMap.get(b));
            const sortedKeys = Array.from(allKeys).sort((a, b) => {
                if (showNetwork) {
                    let [netA, varA] = a.split('###');
                    let [netB, varB] = b.split('###');
                    if (netA !== netB) return netA.localeCompare(netB);
                    return varA.localeCompare(varB);
                }
                return a.localeCompare(b);
            });

            // Grid Construction
            finalGrid = [];
            let headerRow = showNetwork ? ['Network Code', 'Model Variant', ...sortedDates, 'Grand Total'] : ['Model Variant', ...sortedDates, 'Grand Total'];
            finalGrid.push(headerRow);

            let colTotals = new Array(sortedDates.length).fill(0);
            let grandTotalAll = 0;

            sortedKeys.forEach(key => {
                let rowDisplay = showNetwork ? key.split('###') : [key];
                let rowCounts = [];
                let rowTotal = 0;
                sortedDates.forEach((date, idx) => {
                    let count = pivotData[key][date] ? pivotData[key][date].size : 0;
                    rowCounts.push(count === 0 ? '' : count);
                    if (count > 0) { rowTotal += count; colTotals[idx] += count; }
                });
                finalGrid.push([...rowDisplay, ...rowCounts, rowTotal]);
                grandTotalAll += rowTotal;
            });

            let footerLabel = showNetwork ? ['Grand Total', ''] : ['Grand Total'];
            finalGrid.push([...footerLabel, ...colTotals.map(t => t === 0 ? '' : t), grandTotalAll]);

            renderTable(finalGrid, showNetwork);
            
            outputSection.classList.remove('hidden');
            statusDiv.innerHTML = `âœ… Report Ready! Main Dealer Code used for fixes: <b>${defaultCode}</b>.`;
            statusDiv.className = "mt-3 text-sm font-medium text-green-700 h-5";
            document.getElementById('stats').innerText = `Processed ${validRows} valid rows.`;
        }

        function renderTable(grid, isNetworkWise) {
            const table = document.getElementById('reportTable');
            table.innerHTML = '';
            
            // Header
            const thead = document.createElement('thead');
            const trHead = document.createElement('tr');
            grid[0].forEach((cell, i) => {
                const th = document.createElement('th');
                if (i === 0) th.className = "sticky-col-1";
                if (isNetworkWise && i === 1) {
                    th.className = "sticky-col-2";
                    th.style.left = "110px"; 
                }
                th.innerText = cell;
                trHead.appendChild(th);
            });
            thead.appendChild(trHead);
            table.appendChild(thead);

            // Body
            const tbody = document.createElement('tbody');
            for (let i = 1; i < grid.length - 1; i++) {
                const tr = document.createElement('tr');
                grid[i].forEach((cell, j) => {
                    const tag = (j === 0 || (isNetworkWise && j === 1)) ? 'th' : 'td';
                    const el = document.createElement(tag);
                    
                    if (j === 0) el.className = "sticky-col-1 text-left bg-gray-50";
                    if (isNetworkWise && j === 1) {
                        el.className = "sticky-col-2 text-left bg-gray-50";
                        el.style.left = "110px";
                    }
                    if (j > (isNetworkWise ? 1 : 0)) el.className = "text-center";
                    if (j === grid[i].length - 1) el.className += " font-bold bg-blue-50 text-blue-700";
                    
                    el.innerText = cell;
                    tr.appendChild(el);
                });
                tbody.appendChild(tr);
            }
            table.appendChild(tbody);

            // Footer
            const tfoot = document.createElement('tfoot');
            const trFoot = document.createElement('tr');
            const lastRow = grid[grid.length - 1];
            lastRow.forEach((cell, j) => {
                const td = document.createElement('td');
                td.className = "text-center";
                if (j === 0) {
                     td.className += " text-left sticky-col-1";
                     if (isNetworkWise) td.setAttribute("colspan", 2);
                } else if (isNetworkWise && j === 1) {
                    return; 
                }
                td.innerText = cell;
                trFoot.appendChild(td);
            });
            tfoot.appendChild(trFoot);
            table.appendChild(tfoot);
        }

        function clearInput() {
            document.getElementById('csvInput').value = '';
            document.getElementById('outputSection').classList.add('hidden');
            document.getElementById('statusMsg').innerText = '';
        }

        function exportCSV() {
            if (finalGrid.length === 0) return;
            let csvContent = "data:text/csv;charset=utf-8," + finalGrid.map(e => e.join(",")).join("\n");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "Enquiry_Matrix_Report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function copyTable() {
            if (finalGrid.length === 0) return;
            let tsvContent = finalGrid.map(e => e.join("\t")).join("\n");
            navigator.clipboard.writeText(tsvContent).then(() => { alert("Copied to clipboard!"); });
        }
    </script>
</body>
</html>
